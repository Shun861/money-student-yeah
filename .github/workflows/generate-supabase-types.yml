name: Generate Supabase Types

on:
  # SQLファイルの変更時に自動実行
  push:
    paths:
      - 'docs/sql/**'
      - 'supabase/migrations/**'
  
  # 手動実行も可能
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate types even if no SQL changes detected'
        required: false
        default: 'false'

jobs:
  generate-types:
    runs-on: ubuntu-latest
    
    # SQLファイルが変更された場合、または手動実行の場合のみ実行
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.modified, 'sql')
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Supabase CLI
        run: npm install -g supabase

      - name: Generate Supabase types
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        run: |
          # プロジェクトIDをURLから抽出
          PROJECT_ID=$(echo $NEXT_PUBLIC_SUPABASE_URL | sed 's|https://||' | sed 's|\.supabase\.co||')
          echo "Project ID: $PROJECT_ID"
          
          # 型を生成
          npx supabase gen types typescript --project-id $PROJECT_ID --schema public > src/types/supabase-new.ts
          
          # ヘッダーコメントを追加
          cat > src/types/supabase.ts << EOF
          /**
           * Supabase Database Types
           * 
           * This file is auto-generated by GitHub Actions.
           * Do not edit this file manually.
           * 
           * Generated on: $(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
           * Project ID: $PROJECT_ID
           * Schemas: public
           * Commit: ${{ github.sha }}
           * 
           * To regenerate this file locally, run: npm run generate-types
           */
          
          EOF
          
          # 生成された型を追加
          cat src/types/supabase-new.ts >> src/types/supabase.ts
          
          # ヘルパー型を追加
          cat >> src/types/supabase.ts << EOF
          
          // Helper types for easier usage
          export type Tables<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Row'];
          export type TablesInsert<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Insert'];
          export type TablesUpdate<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Update'];
          
          // Commonly used table types
          export type Profile = Tables<'profiles'>;
          export type ProfileInsert = TablesInsert<'profiles'>;
          export type ProfileUpdate = TablesUpdate<'profiles'>;
          EOF
          
          # 一時ファイルを削除
          rm src/types/supabase-new.ts

      - name: Check for changes
        id: verify-changed-files
        run: |
          if git diff --quiet src/types/supabase.ts; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in generated types"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in generated types"
          fi

      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add src/types/supabase.ts
          git commit -m "chore: regenerate Supabase types [skip ci]"
          
          # 現在のブランチにプッシュ
          git push origin HEAD

      - name: Create PR comment (if on PR)
        if: steps.verify-changed-files.outputs.changed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '🔄 **Supabase types have been automatically regenerated** due to database schema changes.\n\nPlease review the updated types in `src/types/supabase.ts`.'
            })

      - name: Generate summary
        run: |
          echo "## 🎯 Supabase Types Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes**: ${{ steps.verify-changed-files.outputs.changed == 'true' && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "### 📝 Changes Made" >> $GITHUB_STEP_SUMMARY
            echo "- Updated \`src/types/supabase.ts\` with latest database schema" >> $GITHUB_STEP_SUMMARY
            echo "- Added generation metadata and helper types" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ℹ️ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Database schema types are already up to date." >> $GITHUB_STEP_SUMMARY
          fi
