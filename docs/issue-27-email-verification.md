# Issue #27: ユーザー登録のメール認証フロー実装

## 🐛 問題の説明

現在のユーザー登録フローではメール認証処理が不完全です：

1. **登録フローの問題**: サインアップ後「サインアップが完了しました。メール確認が必要な場合は案内に従ってください。」と表示されるが、メール確認なしで即座に `/onboarding` にリダイレクトされる
2. **認証ブロック**: メール未確認ユーザーは "Email not confirmed" エラーで進めない
3. **コールバックハンドラー未実装**: Supabase からのメール認証リンクを処理する専用ページがない
4. **Middleware の衝突**: 認証済みだが未確認のユーザーが `/onboarding` から `/login` に戻されるループが発生

## 🎯 期待する動作

**完全なメール認証フロー:**

1. ユーザーが登録フォームを送信
2. 確認待ち専用ページで手順を表示
3. ユーザーが認証リンク付きメールを受信
4. リンククリックで専用認証ページに遷移し以下を表示:
   - 認証処理中のローディングスピナー
   - 認証結果に基づく成功/失敗メッセージ
   - 成功時は `/onboarding` に自動リダイレクト
5. 認証済みユーザーは通常のオンボーディングフローに進行

## 📋 技術要件

### 1. 登録フローの更新
- `signUp` 呼び出しに `emailRedirectTo` オプション追加
- `/onboarding` ではなく確認待ちページにリダイレクト
- メールファーストワークフローに合わせてユーザーメッセージを更新

### 2. メール認証コールバックページの作成
- 新規ページ: `/auth/callback/page.tsx`
- メール認証リンクからの `code` パラメータを処理
- `supabase.auth.exchangeCodeForSession(code)` で認証処理
- ローディング → 成功/エラー → リダイレクトのフロー表示

### 3. メール確認待ちページの作成
- 新規ページ: `/auth/confirm-email/page.tsx` 
- メールを確認して認証リンクをクリックするよう案内
- 認証メール再送信オプション提供
- 既に認証済みのケースを処理

### 4. Middleware ロジックの更新
- `/auth/callback` と `/auth/confirm-email` を `EXEMPT_PATHS` に追加
- ユーザー認証フローでメール認証ステータスを処理

### 5. Supabase 設定
- 本番ドメインを指す Site URL 設定の確認
- Supabase Auth 設定でメール確認必須を確認

## 🚀 実装計画

### フェーズ1: コア認証フロー
- [ ] 認証処理を含む `/auth/callback/page.tsx` 作成
- [ ] 待機案内を含む `/auth/confirm-email/page.tsx` 作成
- [ ] `emailRedirectTo` オプション付きサインアップ呼び出し更新
- [ ] 新規パスを除外するよう middleware 更新

### フェーズ2: UX 改善  
- [ ] ローディング状態とエラーハンドリング追加
- [ ] メール再送信機能実装
- [ ] メールバリデーションフィードバック追加
- [ ] 成功/エラーメッセージ更新

### フェーズ3: 設定とテスト
- [ ] 本番用 Supabase Site URL 設定
- [ ] 開発環境での完全フローテスト
- [ ] メールテンプレートとブランディング確認
- [ ] 新フロー用 E2E テスト更新

## 📁 変更・作成するファイル

### 新規ファイル
- `src/app/auth/callback/page.tsx`
- `src/app/auth/confirm-email/page.tsx`

### 変更ファイル
- `src/app/(auth)/login/page.tsx` - サインアップフロー更新
- `middleware.ts` - 除外パス追加
- `playwright.config.ts` - 必要に応じてテスト設定更新

## 🧪 完了定義（Definition of Done）

- [ ] ユーザーがメール/パスワードで登録可能
- [ ] 登録後にメール確認待ちページにリダイレクト
- [ ] 正しいコールバック URL での認証メール受信
- [ ] 認証リンククリックで認証プロセス完了  
- [ ] 認証済みユーザーが `/onboarding` にリダイレクト
- [ ] Middleware が全認証状態を適切に処理
- [ ] エラー状態の適切な処理
- [ ] 開発・本番両環境でのフロー動作

## 🔗 関連 Issue

- Issue #24-#26 で確立された認証システムに関連
- Issue #25 の Supabase Auth Helpers 実装をベースに構築

## 📈 優先度

**高優先度**（5段階中2番目）- ユーザー登録完了とオンボーディングフローを阻害

## 💡 追加注意事項

この実装は Supabase の推奨メール認証パターンに従い、セキュリティ要件を満たしながら学生ユーザー層にとってスムーズなユーザー体験を確保する必要があります。
