#!/usr/bin/env tsx

import { execSync } from 'child_process';
import { writeFileSync, mkdirSync, existsSync } from 'fs';
import { join } from 'path';
import * as dotenv from 'dotenv';

// ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
dotenv.config({ path: join(process.cwd(), '.env.local') });

/**
 * Supabaseå‹ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * 
 * ç’°å¢ƒå¤‰æ•°ã‹ã‚‰Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å–å¾—ã—ã€
 * TypeScriptå‹å®šç¾©ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
 */

interface GenerateTypesConfig {
  projectId: string;
  supabaseUrl?: string; // undefinedè¨±å¯
  outputPath: string;
  schemas: string[];
}

/**
 * ç’°å¢ƒå¤‰æ•°ã‹ã‚‰Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’æŠ½å‡º
 */
function extractProjectIdFromUrl(url: string): string | null {
  // URLå½¢å¼: https://[project-id].supabase.co
  const match = url.match(/https:\/\/([^.]+)\.supabase\.co/);
  return match ? match[1] : null;
}

/**
 * ç’°å¢ƒå¤‰æ•°ã®ç¢ºèªã¨è¨­å®š
 */
function getSupabaseConfig(): GenerateTypesConfig {
  const supabaseUrl = process.env['NEXT_PUBLIC_SUPABASE_URL'];
  const projectId = process.env['SUPABASE_PROJECT_ID'] || 
    (supabaseUrl ? extractProjectIdFromUrl(supabaseUrl) : null);

  if (!projectId) {
    throw new Error(
      'Supabase project ID not found. Set SUPABASE_PROJECT_ID environment variable or ensure NEXT_PUBLIC_SUPABASE_URL is properly formatted.'
    );
  }

  return {
    projectId,
    supabaseUrl,
    outputPath: join(process.cwd(), 'src', 'types', 'supabase.ts'),
    schemas: ['public']
  };
}

/**
 * å‹ç”Ÿæˆã®å®Ÿè¡Œ
 */
async function generateTypes() {
  try {
    console.log('ğŸ”„ Supabaseå‹ç”Ÿæˆã‚’é–‹å§‹...');
    
    const config = getSupabaseConfig();
    console.log(`ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: ${config.projectId}`);
    console.log(`ğŸ“ å‡ºåŠ›å…ˆ: ${config.outputPath}`);

    // å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    const outputDir = join(process.cwd(), 'src', 'types');
    if (!existsSync(outputDir)) {
      mkdirSync(outputDir, { recursive: true });
      console.log(`ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ: ${outputDir}`);
    }

    // Supabase CLI ã‚’ä½¿ç”¨ã—ã¦å‹ã‚’ç”Ÿæˆ
    const command = `npx supabase gen types typescript --project-id ${config.projectId} --schema ${config.schemas.join(',')}`;
    console.log(`ğŸš€ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: ${command}`);

    const types = execSync(command, { 
      encoding: 'utf-8',
      cwd: process.cwd(),
      stdio: ['pipe', 'pipe', 'pipe']
    });

    // TypeScriptå‹å®šç¾©ã‚’è¿½åŠ ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨å…±ã«ä¿å­˜
    const content = `/**
 * Supabase Database Types
 * 
 * This file is auto-generated by the Supabase CLI.
 * Do not edit this file manually.
 * 
 * Generated on: ${new Date().toISOString()}
 * Project ID: ${config.projectId}
 * Schemas: ${config.schemas.join(', ')}
 * 
 * To regenerate this file, run: npm run generate-types
 */

${types}

// Custom helper types for easier usage (avoiding conflicts with generated types)
export type AppTables<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Row'];
export type AppTablesInsert<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Insert'];
export type AppTablesUpdate<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Update'];

// Commonly used table types with app-specific naming
export type AppProfile = AppTables<'profiles'>;
export type AppProfileInsert = AppTablesInsert<'profiles'>;
export type AppProfileUpdate = AppTablesUpdate<'profiles'>;

export type AppEmployer = AppTables<'employers'>;
export type AppEmployerInsert = AppTablesInsert<'employers'>;
export type AppEmployerUpdate = AppTablesUpdate<'employers'>;

export type AppIncome = AppTables<'incomes'>;
export type AppIncomeInsert = AppTablesInsert<'incomes'>;
export type AppIncomeUpdate = AppTablesUpdate<'incomes'>;

export type AppShift = AppTables<'shifts'>;
export type AppShiftInsert = AppTablesInsert<'shifts'>;
export type AppShiftUpdate = AppTablesUpdate<'shifts'>;

export type AppWorkSchedule = AppTables<'work_schedules'>;
export type AppWorkScheduleInsert = AppTablesInsert<'work_schedules'>;
export type AppWorkScheduleUpdate = AppTablesUpdate<'work_schedules'>;
`;

    writeFileSync(config.outputPath, content);

    console.log('âœ… Supabaseå‹ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    console.log(`ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: ${config.outputPath}`);
    
    // ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®è¡Œæ•°ã‚’è¡¨ç¤º
    const lineCount = content.split('\n').length;
    console.log(`ğŸ“Š ç”Ÿæˆã•ã‚ŒãŸè¡Œæ•°: ${lineCount} è¡Œ`);

  } catch (error) {
    console.error('âŒ å‹ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:');
    
    if (error instanceof Error) {
      console.error(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      
      // Supabase CLIã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
      if (error.message.includes('supabase')) {
        console.error('\nğŸ’¡ è§£æ±ºæ–¹æ³•:');
        console.error('1. Supabase CLIã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèª: npx supabase login');
        console.error('2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒæ­£ã—ã„ã‹ç¢ºèª');
        console.error('3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª');
      }
    } else {
      console.error(error);
    }
    
    process.exit(1);
  }
}

/**
 * ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆ
 */
if (require.main === module) {
  generateTypes().catch(console.error);
}

export { generateTypes, getSupabaseConfig };
